<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™»å½• / æ³¨å†Œ - æèŠï¼ˆå•†ç”¨ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="/assets/css/app.css" />
  <style>
    /* èƒŒæ™¯å›¾ï¼ˆå¯ç”±åå°è®¾ç½®è¦†ç›– --bg-auth-img å˜é‡ï¼‰ */
    .auth-layout {
      background-image: var(--bg-auth-img, linear-gradient(135deg,
        rgba(79,115,248,.12) 0%, rgba(168,85,247,.08) 100%));
      background-size: cover; background-position: center;
    }
    .auth-card { animation: modal-in .3s ease; }
  </style>
</head>
<body>

<!-- èƒŒæ™¯å›¾ç”±åå°é…ç½®æ³¨å…¥ -->
<div id="bg-inject"></div>

<div class="auth-layout" id="authLayout">
  <div class="auth-card">
    <!-- Logo -->
    <div class="auth-logo">
      <div><div class="auth-logo-icon" id="appLogoChar">æ</div></div>
      <h1 id="appName">æèŠï¼ˆå•†ç”¨ç‰ˆï¼‰</h1>
      <p id="appSlogan">å¿«é€Ÿã€å®‰å…¨ã€è½»é‡çš„å³æ—¶é€šè®¯</p>
    </div>

    <!-- Tabs -->
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login"  onclick="switchTab('login')">ç™»å½•</button>
      <button class="auth-tab"        id="tab-register" onclick="switchTab('register')">æ³¨å†Œ</button>
    </div>

    <!-- â”€â”€ ç™»å½•è¡¨å• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <form id="form-login" class="auth-form" onsubmit="doLogin(event)">
      <div class="form-group">
        <label class="form-label" for="l-username">ç”¨æˆ·å</label>
        <input class="form-input" id="l-username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username" required />
      </div>
      <div class="form-group" style="position:relative">
        <label class="form-label" for="l-password">å¯†ç </label>
        <input class="form-input" id="l-password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password" required />
        <button type="button" style="position:absolute;right:.75rem;bottom:.65rem;background:none;border:none;cursor:pointer;font-size:1.1rem" onclick="togglePasswordVisibility(document.getElementById('l-password'),this)">ğŸ‘</button>
      </div>

      <!-- æ»‘å—éªŒè¯ç  -->
      <div id="login-slider-wrap">
        <div class="slider-captcha" id="login-slider"></div>
        <p class="form-hint" style="margin-top:.3rem">è¯·æ‹–åŠ¨æ»‘å—å®ŒæˆéªŒè¯</p>
      </div>

      <button class="btn btn-primary btn-full" type="submit" id="btn-login">ç™»å½•</button>

      <div style="display:flex;align-items:center;gap:.5rem;font-size:.82rem;color:var(--text-secondary);margin-top:.25rem">
        <input type="checkbox" id="l-remember" style="accent-color:var(--primary);cursor:pointer">
        <label for="l-remember" style="cursor:pointer">è®°ä½ç”¨æˆ·åï¼Œä¸‹æ¬¡è‡ªåŠ¨å¡«å…¥</label>
      </div>

      <div class="auth-footer">
        è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchTab('register');return false">ç«‹å³æ³¨å†Œ</a>
        &nbsp;|&nbsp;
        <a href="#" id="forgotLink" onclick="showForgotModal();return false">å¿˜è®°å¯†ç </a>
      </div>
    </form>

    <!-- â”€â”€ æ³¨å†Œè¡¨å• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <form id="form-register" class="auth-form hidden" onsubmit="doRegister(event)">
      <div class="form-group">
        <label class="form-label" for="r-username">ç”¨æˆ·å</label>
        <input class="form-input" id="r-username" type="text" placeholder="3-20ä½å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿" autocomplete="username" required />
      </div>
      <div class="form-group">
        <label class="form-label" for="r-nickname">æ˜µç§°ï¼ˆé€‰å¡«ï¼‰</label>
        <input class="form-input" id="r-nickname" type="text" placeholder="ä¸å¡«åˆ™ä¸ç”¨æˆ·åç›¸åŒ" />
      </div>
      <div class="form-group" style="position:relative">
        <label class="form-label" for="r-password">å¯†ç </label>
        <input class="form-input" id="r-password" type="password" placeholder="è‡³å°‘6ä½" autocomplete="new-password" required />
        <button type="button" style="position:absolute;right:.75rem;bottom:.65rem;background:none;border:none;cursor:pointer;font-size:1.1rem" onclick="togglePasswordVisibility(document.getElementById('r-password'),this)">ğŸ‘</button>
      </div>
      <div class="form-group">
        <label class="form-label" for="r-password2">ç¡®è®¤å¯†ç </label>
        <input class="form-input" id="r-password2" type="password" placeholder="å†æ¬¡è¾“å…¥å¯†ç " autocomplete="new-password" required />
      </div>

      <!-- é‚®ç®±ï¼ˆç”±åå°å¼€å…³æ§åˆ¶ï¼‰ -->
      <div class="form-group" id="field-email" style="display:none">
        <label class="form-label" for="r-email">é‚®ç®± <span style="color:#ef4444">*</span></label>
        <input class="form-input" id="r-email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±" autocomplete="email" />
      </div>

      <!-- æ‰‹æœºå·ï¼ˆç”±åå°å¼€å…³æ§åˆ¶ï¼‰ -->
      <div class="form-group" id="field-phone" style="display:none">
        <label class="form-label" for="r-phone">æ‰‹æœºå· <span style="color:#ef4444">*</span></label>
        <input class="form-input" id="r-phone" type="tel" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" autocomplete="tel" />
      </div>

      <!-- æ»‘å—éªŒè¯ç  -->
      <div id="reg-slider-wrap">
        <div class="slider-captcha" id="reg-slider"></div>
        <p class="form-hint" style="margin-top:.3rem">è¯·æ‹–åŠ¨æ»‘å—å®ŒæˆéªŒè¯</p>
      </div>

      <button class="btn btn-primary btn-full" type="submit" id="btn-register">æ³¨å†Œè´¦å·</button>

      <div class="auth-footer">
        å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchTab('login');return false">ç›´æ¥ç™»å½•</a>
      </div>
    </form>

  </div><!-- /auth-card -->
</div><!-- /auth-layout -->

<div id="toast-container"></div>
<script src="/assets/js/common.js"></script>
<script>
'use strict';

// â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let loginSlider  = null;
let regSlider    = null;
let loginVerified = false;
let regVerified   = false;
let appConfig    = {};

// â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  // è¯»å–åå°é…ç½®ï¼ˆåº”ç”¨åã€èƒŒæ™¯å›¾ã€éªŒè¯ç å¼€å…³ç­‰ï¼‰
  const res = await api('settings/public', {}, 'GET').catch(() => ({code:-1}));
  if (res.code === 0) {
    appConfig = res.data ?? {};
    // åº”ç”¨ UI çš®è‚¤
    if (appConfig.ui_skin) applyUITheme(appConfig.ui_skin);
    // åº”ç”¨å/å£å·
    if (appConfig.app_name) {
      document.title = `ç™»å½• / æ³¨å†Œ - ${appConfig.app_name}`;
      document.getElementById('appName').textContent = appConfig.app_name;
    }
    // ç™»å½•é¡µèƒŒæ™¯
    if (appConfig.login_bg) {
      document.getElementById('authLayout').style.backgroundImage = `url(${appConfig.login_bg})`;
    }
    // è‡ªå®šä¹‰ CSS
    if (appConfig.custom_css_login) {
      const style = document.createElement('style');
      style.textContent = appConfig.custom_css_login;
      document.head.appendChild(style);
    }
    // é‚®ç®±/æ‰‹æœºå­—æ®µæ˜¾ç¤º
    if (appConfig.register_email_verify === '1') {
      document.getElementById('field-email').style.display = '';
    }
    if (appConfig.register_phone_verify === '1') {
      document.getElementById('field-phone').style.display = '';
    }
  }

  // åˆå§‹åŒ–æ»‘å—éªŒè¯ç 
  const captchaEnable = appConfig.captcha_slider_enable !== '0';
  if (captchaEnable) {
    loginSlider = new SliderCaptcha(document.getElementById('login-slider'), () => { loginVerified = true; });
    regSlider   = new SliderCaptcha(document.getElementById('reg-slider'),   () => { regVerified   = true; });
  } else {
    document.getElementById('login-slider-wrap').style.display = 'none';
    document.getElementById('reg-slider-wrap').style.display   = 'none';
    loginVerified = true;
    regVerified   = true;
  }

  // URL å‚æ•°è‡ªåŠ¨åˆ‡æ¢æ ‡ç­¾
  const params = new URLSearchParams(location.search);
  if (params.get('tab') === 'register') switchTab('register');
})();

// â”€â”€ åˆ‡æ¢ç™»å½•/æ³¨å†Œ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.getElementById('form-login').classList.toggle('hidden',    tab !== 'login');
  document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
  document.getElementById('tab-login').classList.toggle('active',     tab === 'login');
  document.getElementById('tab-register').classList.toggle('active',  tab === 'register');
}

// â”€â”€ ç™»å½•é€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin(e) {
  e.preventDefault();
  if (!loginVerified) { toast('è¯·å…ˆå®Œæˆæ»‘å—éªŒè¯', 'warning'); loginSlider?.reset(); return; }

  const btn = document.getElementById('btn-login');
  btn.disabled = true; btn.textContent = 'ç™»å½•ä¸­â€¦';

  const res = await api('auth/login', {
    username: document.getElementById('l-username').value.trim(),
    password: document.getElementById('l-password').value,
  });

  btn.disabled = false; btn.textContent = 'ç™»å½•';
  if (res.code === 0) {
    // å¤„ç†è®°ä½ç”¨æˆ·å
    const username = document.getElementById('l-username').value.trim();
    if (document.getElementById('l-remember').checked) {
      localStorage.setItem('jl_remember_user', username);
    } else {
      localStorage.removeItem('jl_remember_user');
    }

    if (res.cancelling) {
      // è´¦å·å¤„äºæ³¨é”€å†·é™æœŸï¼Œè¯¢é—®æ˜¯å¦æ¢å¤
      showModal({
        title: 'âš ï¸ è´¦å·æ³¨é”€å†·é™æœŸ',
        body: `<div style="background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:8px;padding:.875rem;margin-bottom:.75rem;font-size:.875rem;color:#dc2626">
          æ‚¨çš„è´¦å·å·²ç”³è¯·æ³¨é”€ï¼Œå†·é™æœŸè¿˜å‰© <strong>${res.recover_days_left}</strong> å¤©ï¼ˆæˆªæ­¢ ${res.recover_deadline?.slice(0,10)}ï¼‰ã€‚<br>
          å†·é™æœŸè¿‡åè´¦å·å°†æ°¸ä¹…åˆ é™¤ï¼Œæ˜¯å¦ç«‹å³æ¢å¤è´¦å·ï¼Ÿ
        </div>`,
        confirmText: 'ç«‹å³æ¢å¤è´¦å·',
        cancelText: 'æš‚ä¸æ¢å¤ï¼Œè¿›å…¥èŠå¤©',
        onConfirm: async () => {
          const rRes = await api('user/recover', {});
          if (rRes.code === 0) {
            toast('è´¦å·å·²æ¢å¤ï¼Œæ­£åœ¨è¿›å…¥â€¦', 'success');
          } else {
            toast(rRes.msg || 'æ¢å¤å¤±è´¥', 'error');
          }
          setTimeout(() => { location.href = '/app.html'; }, 800);
        },
        onCancel: () => { location.href = '/app.html'; }
      });
    } else {
      toast('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬â€¦', 'success');
      showLoading('æ­£åœ¨è¿›å…¥èŠå¤©å®¤â€¦');
      setTimeout(() => { location.href = '/app.html'; }, 800);
    }
  } else {
    toast(res.msg || 'ç™»å½•å¤±è´¥', 'error');
    loginVerified = false; loginSlider?.reset();
    document.getElementById('l-password').value = '';
  }
}

// â”€â”€ æ³¨å†Œé€»è¾‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRegister(e) {
  e.preventDefault();
  if (!regVerified) { toast('è¯·å…ˆå®Œæˆæ»‘å—éªŒè¯', 'warning'); regSlider?.reset(); return; }

  const pwd  = document.getElementById('r-password').value;
  const pwd2 = document.getElementById('r-password2').value;
  if (pwd !== pwd2) { toast('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error'); return; }
  if (pwd.length < 6) { toast('å¯†ç ä¸èƒ½å°‘äº6ä½', 'error'); return; }

  const btn = document.getElementById('btn-register');
  btn.disabled = true; btn.textContent = 'æ³¨å†Œä¸­â€¦';

  const res = await api('auth/register', {
    username: document.getElementById('r-username').value.trim(),
    nickname: document.getElementById('r-nickname').value.trim(),
    password: pwd,
    email:    document.getElementById('r-email')?.value?.trim() ?? '',
    phone:    document.getElementById('r-phone')?.value?.trim() ?? '',
  });

  btn.disabled = false; btn.textContent = 'æ³¨å†Œè´¦å·';
  if (res.code === 0) {
    toast(`æ³¨å†ŒæˆåŠŸï¼æ‚¨çš„è´¦å· ID æ˜¯ ${res.uid}ï¼Œè¯·ç™»å½•`, 'success', 5000);
    regVerified = false; regSlider?.reset();
    switchTab('login');
  } else {
    toast(res.msg || 'æ³¨å†Œå¤±è´¥', 'error');
    regVerified = false; regSlider?.reset();
  }
}

// â”€â”€ å¿˜è®°å¯†ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showForgotModal() {
  showModal({
    title: 'é‡ç½®å¯†ç ',
    body: `<div class="form-group">
      <label class="form-label">æ³¨å†Œé‚®ç®±</label>
      <input class="form-input" id="forgot-email" type="email" placeholder="è¯·è¾“å…¥æ³¨å†Œé‚®ç®±" />
    </div>
    <p class="form-hint" style="margin-top:.5rem">ç³»ç»Ÿå°†å‘æ‚¨çš„é‚®ç®±å‘é€é‡ç½®é“¾æ¥ï¼ˆéœ€åå°å·²é…ç½® SMTPï¼‰</p>`,
    confirmText: 'å‘é€é‡ç½®é‚®ä»¶',
    onConfirm: async () => {
      const email = document.getElementById('forgot-email')?.value?.trim();
      if (!email) { toast('è¯·è¾“å…¥é‚®ç®±', 'error'); return; }
      toast('åŠŸèƒ½å¼€å‘ä¸­ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é‡ç½®å¯†ç ', 'info');
    }
  });
}
</script>
</body>
</html>
