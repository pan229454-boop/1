<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>æèŠï¼ˆå•†ç”¨ç‰ˆï¼‰</title>
  <!-- session-id ç”±æœåŠ¡ç«¯æ¸²æŸ“æ³¨å…¥ -->
  <meta name="session-id" content="" id="meta-session" />
  <link rel="stylesheet" href="/assets/css/app.css" />
</head>
<body>

<!-- å…¨å±åŠ è½½é®ç½©ï¼ˆç­‰å¾… WS è®¤è¯å®Œæˆï¼‰-->
<div class="loading-overlay" id="initOverlay">
  <div class="spinner"></div>
  <p>æ­£åœ¨è¿æ¥æœåŠ¡å™¨â€¦</p>
</div>

<div class="app-layout" id="appRoot" style="visibility:hidden">

  <!-- â”€â”€ å·¦ä¾§å¯¼èˆªæ  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="nav-rail">
    <div class="nav-rail-logo">æ</div>

    <!-- ä¼šè¯ -->
    <button class="nav-rail-btn active" id="nav-chat" title="èŠå¤©" onclick="switchPanel('chat')">
      ğŸ’¬
      <span class="badge" id="total-unread" style="display:none">0</span>
    </button>
    <!-- é€šè®¯å½• -->
    <button class="nav-rail-btn" id="nav-contact" title="é€šè®¯å½•" onclick="switchPanel('contact')">ğŸ‘¥</button>
    <!-- æœç´¢ -->
    <button class="nav-rail-btn" id="nav-search" title="æœç´¢" onclick="openGlobalSearch()">ğŸ”</button>

    <span class="nav-rail-spacer"></span>

    <!-- ä¸»é¢˜åˆ‡æ¢ -->
    <button class="nav-rail-btn js-theme-toggle" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    <!-- å½“å‰ç”¨æˆ·å¤´åƒå¤´åƒï¼ˆç‚¹å‡»å±•ç¤ºèœå•ï¼‰-->
    <div class="relative">
      <div id="self-avatar-btn" title="æˆ‘çš„è´¦å·" onclick="showMeMenu()" style="cursor:pointer;display:flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:50%;overflow:hidden;margin:0 auto">
        <div class="skeleton" style="width:36px;height:36px;border-radius:50%"></div>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ ä¼šè¯åˆ—è¡¨é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="session-panel" id="panel-chat">
    <div class="session-panel-header">
      <span class="session-panel-title">æ¶ˆæ¯</span>
      <div style="display:flex;gap:.25rem">
        <button class="btn-icon" title="æ–°å»ºç¾¤ç»„" onclick="createGroupModal()">+</button>
        <button class="btn-icon" id="menuBtn" onclick="showMainMenu(this)">â˜°</button>
      </div>
    </div>
    <!-- åœ¨çº¿äººæ•° -->
    <div style="padding:.5rem 1rem;background:rgba(79,115,248,.06);font-size:.78rem;color:var(--text-secondary);display:flex;align-items:center;gap:.5rem;">
      <span style="width:8px;height:8px;background:#22c55e;border-radius:50%;display:inline-block"></span>
      åº”åˆ° <strong id="totalCount">-</strong> äºº Â· åœ¨çº¿ <strong id="onlineCount">-</strong> äºº
    </div>
    <!-- æœç´¢æ¡† -->
    <div class="session-search">
      <input type="search" id="sessionSearch" placeholder="æœç´¢ä¼šè¯â€¦" oninput="filterSessions(this.value)" />
    </div>
    <!-- ä¼šè¯åˆ—è¡¨ -->
    <div class="session-list" id="sessionList"></div>
  </div>

  <!-- é€šè®¯å½•é¢æ¿ -->
  <div class="session-panel hidden" id="panel-contact">
    <div class="session-panel-header">
      <span class="session-panel-title">é€šè®¯å½•</span>
      <button class="btn-icon" onclick="addFriendModal()" title="æ·»åŠ å¥½å‹">+</button>
    </div>
    <div style="padding:.75rem 1rem;font-size:.8rem;font-weight:700;color:var(--text-muted)">å¥½å‹åˆ—è¡¨</div>
    <div class="session-list" id="friendList"></div>
  </div>

  <!-- â”€â”€ èŠå¤©åŒºåŸŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="chat-area" id="chatArea">
    <!-- é»˜è®¤ç©ºæ€ -->
    <div id="chatEmpty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:1rem;color:var(--text-muted)">
      <div style="font-size:4rem">ğŸ’¬</div>
      <p style="font-size:1rem">é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹èŠå¤©</p>
    </div>

    <!-- èŠå¤©å®¹å™¨ï¼ˆé€‰ä¸­ä¼šè¯åæ˜¾ç¤ºï¼‰-->
    <div id="chatContainer" style="display:none;flex-direction:column;height:100%;">
      <!-- å…¬å‘Šæ¡ -->
      <div class="notice-bar hidden" id="noticeBar">
        <span>ğŸ“¢</span>
        <span id="noticeContent" class="truncate flex-1">æš‚æ— å…¬å‘Š</span>
      </div>
      <!-- ç½®é¡¶æ¶ˆæ¯æ¡ -->
      <div class="chat-pin-bar hidden" id="pinBar">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15l-9-9M3 21l4-4m0 0l2-2m-2 2l-2-2m9-4l-7 7m3-7l7-7"/></svg>
        <span id="pinContent" class="truncate flex-1">ç½®é¡¶æ¶ˆæ¯åŠ è½½ä¸­â€¦</span>
      </div>
      <!-- èŠå¤©å¤´éƒ¨ -->
      <div class="chat-header">
        <div style="display:flex;align-items:center;gap:.5rem">
          <!-- ç§»åŠ¨ç«¯è¿”å›æŒ‰é’® -->
          <button class="btn-icon" id="backBtn" onclick="closeChat()" style="display:none">â†</button>
          <div class="chat-header-info" id="chatHeaderInfo">
            <div class="skeleton avatar-sm" style="border-radius:50%"></div>
            <div>
              <div class="skeleton" style="width:80px;height:14px;margin-bottom:4px"></div>
              <div class="skeleton" style="width:50px;height:11px"></div>
            </div>
          </div>
        </div>
        <div class="chat-header-actions">
          <button class="btn-icon" title="æœç´¢æ¶ˆæ¯" onclick="openMsgSearch()">ğŸ”</button>
          <button class="btn-icon" title="æˆå‘˜åˆ—è¡¨" onclick="toggleInfoPanel()">ğŸ‘¥</button>
          <button class="btn-icon" id="chatMenuBtn" title="æ›´å¤š" onclick="showChatMenu()">â‹®</button>
        </div>
      </div>

      <!-- æ¶ˆæ¯åˆ—è¡¨ -->
      <div class="chat-messages" id="chatMessages"></div>

      <!-- è¾“å…¥åŒº -->
      <div class="chat-input-area">
        <!-- å¼•ç”¨å›å¤é¢„è§ˆæ¡ -->
        <div class="reply-bar hidden" id="replyBar">
          <span class="truncate flex-1" id="replyPreview">å›å¤å†…å®¹</span>
          <button onclick="clearReply()" style="background:none;border:none;cursor:pointer;color:var(--text-muted)">âœ•</button>
        </div>
        <!-- å·¥å…·æ  -->
        <div class="chat-input-toolbar">
          <label class="btn-icon" title="å‘é€å›¾ç‰‡" style="cursor:pointer">
            ğŸ“· <input type="file" accept="image/*" style="display:none" id="imgUpload" onchange="sendImage(this)" />
          </label>
          <button class="btn-icon" title="è¡¨æƒ…" onclick="toast('è¡¨æƒ…åŠŸèƒ½å³å°†ä¸Šçº¿','info')">ğŸ˜Š</button>
        </div>
        <!-- è¾“å…¥æ¡† + å‘é€ -->
        <div class="chat-input-row relative">
          <!-- @æåŠä¸‹æ‹‰ -->
          <div class="at-suggest hidden" id="atSuggest"></div>
          <textarea
            class="chat-input-box"
            id="chatInput"
            placeholder="è¾“å…¥æ¶ˆæ¯â€¦ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ"
            rows="1"
            maxlength="2000"
            onkeydown="handleInputKey(event)"
            oninput="handleInputChange(this)"
          ></textarea>
          <button class="btn btn-primary btn-sm" onclick="sendMessage()" id="sendBtn">å‘é€</button>
        </div>
      </div>
    </div><!-- /chatContainer -->
  </main><!-- /chatArea -->

  <!-- â”€â”€ å³ä¾§ä¿¡æ¯é¢æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="info-panel" id="infoPanel" style="display:none">
    <div id="infoPanelContent"></div>
  </aside>

</div><!-- /appRoot -->

<div id="toast-container"></div>
<script src="/assets/js/common.js"></script>
<script>
'use strict';

// ================================================================
//  å…¨å±€çŠ¶æ€
// ================================================================
let ME = null;           // å½“å‰ç”¨æˆ·ä¿¡æ¯ { uid, nickname, avatar, role }
let WS = null;           // JLSocket å®ä¾‹
let currentSession = null; // { type:'group'|'private', id:str, name:str }
let WS_URL = 'ws' + (location.protocol === 'https:' ? 's' : '') + '://' + location.host + '/ws';
let sessions = [];       // ä¼šè¯åˆ—è¡¨ç¼“å­˜
let replyMsg  = null;    // å½“å‰å¼•ç”¨å›å¤çš„æ¶ˆæ¯å¯¹è±¡
let groupMembers = {};   // gid => æˆå‘˜åˆ—è¡¨ (ç”¨äº @æåŠ)
let unreadMap = {};      // 'g_0001' | 'p_uid' => æœªè¯»æ•°

// ================================================================
//  åˆå§‹åŒ–æµç¨‹
// ================================================================
(async function init() {
  // 1. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆæ£€æµ‹ç™»å½•çŠ¶æ€ï¼‰
  const meRes = await api('auth/me', {}, 'GET');
  if (!meRes.data) {
    location.href = '/auth.html';
    return;
  }
  ME = meRes.data;

  // 2. æ³¨å…¥ session-idï¼ˆç”¨äº WS è®¤è¯ï¼‰
  // PHP ä¾§åœ¨ HTML æ¸²æŸ“æ—¶æ³¨å…¥ï¼Œæ­¤å¤„é€šè¿‡ cookie è·å–
  document.getElementById('meta-session').content = meRes.data.session_id ?? '';

  // 3. æ¸²æŸ“å·¦ä¸Šè§’ç”¨æˆ·å¤´åƒ
  renderSelfAvatar();

  // 4. åŠ è½½åœ¨çº¿äººæ•°
  loadOnlineCount();
  setInterval(loadOnlineCount, 30000);

  // 5. è¿æ¥ WebSocket
  connectWS();

  // 6. åŠ è½½ä¼šè¯åˆ—è¡¨ï¼ˆç¾¤ + å¥½å‹ï¼‰
  await loadSessions();

  // 7. éšè—åŠ è½½å±‚
  document.getElementById('initOverlay').style.display = 'none';
  document.getElementById('appRoot').style.visibility = '';

  // 8. æ‰‹æœºç«¯èƒŒæ™¯é€‚é…
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) loadOnlineCount();
  });

  // 9. ç§»åŠ¨ç«¯è¿”å›æŒ‰é’®
  if (window.innerWidth <= 768) {
    document.getElementById('backBtn').style.display = '';
  }
})();

// ================================================================
//  WebSocket è¿æ¥
// ================================================================
function connectWS() {
  WS = new JLSocket(WS_URL, {
    onauth: (pkt) => {
      console.info('[App] WS è®¤è¯æˆåŠŸ, uid=', pkt.uid);
    },
    onmsg: (pkt) => handleWsMessage(pkt),
    onclose: () => {
      // çŸ­æš‚æ˜¾ç¤ºæ–­çº¿æç¤ºï¼ˆJLSocket è‡ªåŠ¨é‡è¿ä¸­ï¼‰
      toast('è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨é‡è¿â€¦', 'warning', 2500);
    }
  });
  WS.connect();
}

// ================================================================
//  å¤„ç† WS æ”¶åˆ°çš„æ¶ˆæ¯ packet
// ================================================================
function handleWsMessage(pkt) {
  switch (pkt.type) {
    case 'msg':
      onReceiveMsg(pkt);
      break;
    case 'recall':
      onRecallMsg(pkt);
      break;
    case 'unread':
      onUnreadUpdate(pkt);
      break;
  }
}

/** æ”¶åˆ°æ–°æ¶ˆæ¯ */
function onReceiveMsg(pkt) {
  const sessionKey = pkt.chat_type === 2 ? `g_${pkt.to_id}` : `p_${pkt.from_uid == ME.uid ? pkt.to_id : pkt.from_uid}`;

  // æ˜¯å¦åœ¨å½“å‰ä¼šè¯
  const isCurrent = currentSession && (
    (pkt.chat_type === 2 && currentSession.type === 'group'   && currentSession.id === pkt.to_id) ||
    (pkt.chat_type === 1 && currentSession.type === 'private' && currentSession.id == (pkt.from_uid == ME.uid ? pkt.to_id : pkt.from_uid))
  );

  if (isCurrent) {
    const atBottom = isAtBottom(document.getElementById('chatMessages'));
    appendMessage(pkt);
    if (atBottom) scrollToBottom(document.getElementById('chatMessages'));
    // æ ‡è®°å·²è¯»
    WS.sendMsg({ type: 'read', chat_type: pkt.chat_type, from_id: pkt.chat_type === 2 ? pkt.to_id : String(pkt.from_uid) });
  } else {
    // æœªè¯»+1
    unreadMap[sessionKey] = (unreadMap[sessionKey] ?? 0) + 1;
    updateSessionPreview(sessionKey, pkt);
    renderUnreadBadges();
  }
}

/** æ’¤å›æ¶ˆæ¯ */
function onRecallMsg(pkt) {
  const el = document.querySelector(`[data-msg-id="${pkt.msg_id}"]`);
  if (el) {
    const bubble = el.querySelector('.msg-bubble');
    if (bubble) bubble.textContent = 'æ¶ˆæ¯å·²è¢«æ’¤å›';
    bubble?.classList.add('text-muted');
  }
}

/** æ›´æ–°æœªè¯» */
function onUnreadUpdate(pkt) {
  (pkt.data ?? []).forEach(u => {
    const k = u.chat_type === 2 ? `g_${u.from_id}` : `p_${u.from_id}`;
    unreadMap[k] = u.cnt;
  });
  renderUnreadBadges();
}

// ================================================================
//  ä¼šè¯åˆ—è¡¨
// ================================================================
async function loadSessions() {
  const [groupRes, friendRes] = await Promise.all([
    api('group/list', {}, 'GET'),
    api('friend/list', {}, 'GET'),
  ]);

  sessions = [];

  // ç¾¤ç»„
  (groupRes.data ?? []).forEach(g => {
    sessions.push({ type: 'group', id: g.gid, name: g.name, avatar: g.avatar, is_default: g.is_default, role: g.role });
  });
  // å¥½å‹
  (friendRes.data ?? []).forEach(f => {
    sessions.push({ type: 'private', id: String(f.uid), name: f.nickname, avatar: f.avatar, online: f.is_online });
  });

  renderSessionList(sessions);
  renderFriendList(friendRes.data ?? []);
}

/** æ¸²æŸ“ä¼šè¯åˆ—è¡¨ */
function renderSessionList(list) {
  const container = document.getElementById('sessionList');
  container.innerHTML = '';
  list.forEach(s => {
    const key  = s.type === 'group' ? `g_${s.id}` : `p_${s.id}`;
    const unread = unreadMap[key] ?? 0;
    const div  = document.createElement('div');
    div.className = 'session-item';
    div.dataset.key = key;
    div.onclick = () => openSession(s);
    div.innerHTML = `
      <div class="relative flex-shrink-0">
        ${s.avatar
          ? `<img src="${escHtml(s.avatar)}" class="avatar avatar-md" alt="${escHtml(s.name)}">`
          : avatarHtml(s.name, 'avatar-md')}
        ${s.type === 'private' && s.online ? '<span class="online-dot"></span>' : ''}
        ${unread > 0 ? `<span class="badge">${unread > 99 ? '99+' : unread}</span>` : ''}
      </div>
      <div class="session-info">
        <div class="session-name truncate">${escHtml(s.name)}${s.type === 'group' ? ` <span class="text-xs text-muted">#${s.id}</span>` : ''}</div>
        <div class="session-preview" id="preview-${key}">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
      </div>`;
    container.appendChild(div);
  });
}

/** æ¸²æŸ“å¥½å‹åˆ—è¡¨ */
function renderFriendList(friends) {
  const container = document.getElementById('friendList');
  container.innerHTML = '';
  if (!friends.length) {
    container.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-muted);font-size:.85rem">æš‚æ— å¥½å‹ï¼Œå»ç¾¤é‡Œ @ ä¸€ä¸‹å§</div>';
    return;
  }
  friends.forEach(f => {
    const div = document.createElement('div');
    div.className = 'session-item';
    div.onclick = () => openSession({ type: 'private', id: String(f.uid), name: f.nickname, avatar: f.avatar });
    div.innerHTML = `
      <div class="relative flex-shrink-0">
        ${f.avatar ? `<img src="${escHtml(f.avatar)}" class="avatar avatar-md">` : avatarHtml(f.nickname, 'avatar-md')}
        ${f.is_online ? '<span class="online-dot"></span>' : ''}
      </div>
      <div class="session-info">
        <div class="session-name">${escHtml(f.nickname)}</div>
        <div class="session-preview text-muted">${f.is_online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
      </div>`;
    container.appendChild(div);
  });
}

/** æ›´æ–°ä¼šè¯é¢„è§ˆæ–‡å­— */
function updateSessionPreview(key, msg) {
  const el = document.getElementById(`preview-${key}`);
  if (el) {
    const prefix = msg.from_uid == ME.uid ? 'æˆ‘: ' : '';
    const text   = msg.msg_type === 2 ? '[å›¾ç‰‡]' : (msg.content ?? '').slice(0, 30);
    el.textContent = `${prefix}${text}`;
  }
}

/** è¿‡æ»¤ä¼šè¯ */
function filterSessions(q) {
  if (!q) { renderSessionList(sessions); return; }
  const filtered = sessions.filter(s => s.name.toLowerCase().includes(q.toLowerCase()) || s.id.includes(q));
  renderSessionList(filtered);
}

/** æ¸²æŸ“æœªè¯»å¾½ç«  */
function renderUnreadBadges() {
  const total = Object.values(unreadMap).reduce((a,b) => a + b, 0);
  const badge = document.getElementById('total-unread');
  badge.textContent = total > 99 ? '99+' : String(total);
  badge.style.display = total > 0 ? '' : 'none';

  // å„ä¼šè¯çº¢ç‚¹
  document.querySelectorAll('.session-item').forEach(item => {
    const key    = item.dataset.key;
    const unread = unreadMap[key] ?? 0;
    const dot    = item.querySelector('.badge');
    if (dot) { dot.textContent = unread > 99 ? '99+' : unread; dot.style.display = unread > 0 ? '' : 'none'; }
  });
}

// ================================================================
//  æ‰“å¼€ä¼šè¯
// ================================================================
async function openSession(s) {
  currentSession = s;
  document.getElementById('chatEmpty').style.display = 'none';
  const cc = document.getElementById('chatContainer');
  cc.style.display = 'flex';

  // é«˜äº®é€‰ä¸­
  document.querySelectorAll('.session-item').forEach(el => {
    el.classList.toggle('active', el.dataset.key === (s.type === 'group' ? `g_${s.id}` : `p_${s.id}`));
  });

  // æ¸…é™¤è¯¥ä¼šè¯æœªè¯»
  const key = s.type === 'group' ? `g_${s.id}` : `p_${s.id}`;
  delete unreadMap[key];
  renderUnreadBadges();
  WS.sendMsg({ type: 'read', chat_type: s.type === 'group' ? 2 : 1, from_id: s.id });

  // æ›´æ–°å¤´éƒ¨
  renderChatHeader(s);

  // åŠ è½½å†å²æ¶ˆæ¯
  await loadHistory(s);

  // ç¾¤ï¼šåŠ è½½å…¬å‘Šã€æˆå‘˜
  if (s.type === 'group') {
    loadGroupNotice(s.id);
    loadGroupMembers(s.id);
  }

  // æ‰‹æœºç«¯ï¼šéšè—ä¾§è¾¹æ 
  if (window.innerWidth <= 768) {
    document.getElementById('panel-chat').classList.remove('open');
  }

  document.getElementById('chatInput').focus();
}

/** æ¸²æŸ“èŠå¤©å¤´éƒ¨ */
function renderChatHeader(s) {
  document.getElementById('chatHeaderInfo').innerHTML = `
    ${s.avatar ? `<img src="${escHtml(s.avatar)}" class="avatar avatar-sm">` : avatarHtml(s.name, 'avatar-sm')}
    <div>
      <div class="chat-header-name">${escHtml(s.name)}</div>
      <div class="chat-header-sub" id="chatSubtitle">${s.type === 'group' ? `ç¾¤å·ï¼š${s.id}` : (s.online ? 'åœ¨çº¿' : 'ç¦»çº¿')}</div>
    </div>`;
}

/** åŠ è½½å†å²æ¶ˆæ¯ */
async function loadHistory(s) {
  const msgs = document.getElementById('chatMessages');
  msgs.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:.82rem;padding:1rem">åŠ è½½ä¸­â€¦</div>';

  const res = await api('msg/history', {
    chat_type: s.type === 'group' ? 2 : 1,
    to_id:     s.id,
    limit:     50,
  });

  msgs.innerHTML = '';
  if (res.code === 0 && res.data?.length) {
    res.data.forEach(m => appendMessage({
      msg_id: m.id, chat_type: s.type === 'group' ? 2 : 1,
      from_uid: m.from, from_nickname: m.from, // éœ€ lookupï¼Œç®€åŒ–å¤„ç†
      msg_type: m.type, content: m.content, reply_msg_id: m.reply, ts: m.ts,
    }));
    scrollToBottom(msgs, false);
  } else {
    msgs.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:.82rem;padding:2rem">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
  }
}

/** åŠ è½½ç¾¤å…¬å‘Š */
async function loadGroupNotice(gid) {
  const res = await api('notice/get', { gid }, 'GET');
  const bar = document.getElementById('noticeBar');
  if (res.code === 0 && res.data) {
    document.getElementById('noticeContent').textContent = res.data.content;
    bar.classList.remove('hidden');
  } else {
    bar.classList.add('hidden');
  }
}

/** åŠ è½½ç¾¤æˆå‘˜ï¼ˆç”¨äº @æåŠï¼‰*/
async function loadGroupMembers(gid) {
  const res = await api('group/info', { gid }, 'GET');
  if (res.code === 0) {
    groupMembers[gid] = res.data.members ?? [];
    // æ›´æ–°å¤´éƒ¨äººæ•°
    document.getElementById('chatSubtitle').textContent =
      `ç¾¤å·ï¼š${gid} Â· ${groupMembers[gid].length} äºº`;
  }
}

// ================================================================
//  æ¸²æŸ“æ¶ˆæ¯æ°”æ³¡
// ================================================================
function appendMessage(pkt) {
  const msgs = document.getElementById('chatMessages');
  const isSelf = pkt.from_uid == ME.uid;

  const div = document.createElement('div');
  div.className = `msg-group ${isSelf ? 'self' : 'other'}`;
  div.dataset.msgId = pkt.msg_id;

  let bubbleContent = '';
  if (pkt.msg_type === 2) {
    bubbleContent = `<img src="${escHtml(pkt.content)}" class="js-lightbox" alt="å›¾ç‰‡" loading="lazy">`;
  } else {
    bubbleContent = parseContent(pkt.content ?? '');
  }

  // å¼•ç”¨å›å¤
  let replyHtml = '';
  if (pkt.reply_msg_id) {
    replyHtml = `<div class="msg-reply-preview">â†© å¼•ç”¨æ¶ˆæ¯ #${escHtml(String(pkt.reply_msg_id).slice(0,8))}</div>`;
  }

  const nickHtml = !isSelf
    ? `<div class="msg-sender">${escHtml(String(pkt.from_nickname ?? pkt.from_uid))}${pkt.from_title ? ` <span class="msg-title">[${escHtml(pkt.from_title)}]</span>` : ''}</div>`
    : '';

  div.innerHTML = `
    <div class="relative flex-shrink-0" style="cursor:pointer" onclick="clickAvatar(${pkt.from_uid})">
      ${avatarHtml(String(pkt.from_nickname ?? pkt.from_uid), 'avatar-sm')}
    </div>
    <div class="msg-content-wrap flex-1">
      ${nickHtml}
      ${replyHtml}
      <div class="msg-bubble">${bubbleContent}</div>
      <div class="msg-time">${formatTime(pkt.ts)}</div>
    </div>`;

  // é•¿æŒ‰ / å³é”®ä¸Šä¸‹æ–‡èœå•
  div.addEventListener('contextmenu', (e) => { e.preventDefault(); showMsgMenu(e, pkt); });
  div.addEventListener('touchstart', makeLongPressHandler((e) => showMsgMenu(e, pkt)), { passive: true });

  msgs.appendChild(div);
}

// ================================================================
//  å‘é€æ¶ˆæ¯
// ================================================================
async function sendMessage() {
  if (!currentSession) return;
  const input   = document.getElementById('chatInput');
  const content = input.value.trim();
  if (!content) return;

  // è§£æ @æåŠ
  const atMatches = content.match(/@(\S+)/g) ?? [];
  const atNicks   = atMatches.map(m => m.slice(1));
  const gid       = currentSession.type === 'group' ? currentSession.id : null;
  const atUids    = gid ? (groupMembers[gid] ?? [])
    .filter(m => atNicks.includes(m.nickname))
    .map(m => m.uid) : [];

  const pkt = {
    type:          'msg',
    chat_type:     currentSession.type === 'group' ? 2 : 1,
    to_id:         currentSession.id,
    msg_type:      1,
    content,
    reply_msg_id:  replyMsg?.msg_id ?? null,
    at_uids:       atUids,
  };

  input.value = '';
  input.style.height = '';
  clearReply();

  WS.sendMsg(pkt);
  // æœ¬åœ°ç«‹å³æ¸²æŸ“ï¼ˆä¹è§‚ UIï¼‰
  appendMessage({
    ...pkt, from_uid: ME.uid,
    from_nickname: ME.nickname,
    msg_id: 'local_' + Date.now(),
    ts: new Date().toISOString(),
  });
  scrollToBottom(document.getElementById('chatMessages'));
}

/** å‘é€å›¾ç‰‡ */
async function sendImage(input) {
  if (!input.files.length || !currentSession) return;
  const form = new FormData();
  form.append('image', input.files[0]);
  showLoading('ä¸Šä¼ ä¸­â€¦');
  const res = await apiUpload('upload/image', form);
  hideLoading();
  input.value = '';
  if (res.code !== 0) { toast(res.msg || 'ä¸Šä¼ å¤±è´¥', 'error'); return; }
  const pkt = {
    type: 'msg', chat_type: currentSession.type === 'group' ? 2 : 1,
    to_id: currentSession.id, msg_type: 2, content: res.url,
    reply_msg_id: null, at_uids: [],
  };
  WS.sendMsg(pkt);
  appendMessage({ ...pkt, from_uid: ME.uid, from_nickname: ME.nickname, msg_id: 'local_' + Date.now(), ts: new Date().toISOString() });
  scrollToBottom(document.getElementById('chatMessages'));
}

// ================================================================
//  è¾“å…¥æ¡†å¤„ç†
// ================================================================
function handleInputKey(e) {
  // Enter å‘é€ï¼›Shift+Enter æ¢è¡Œ
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    // å¦‚æœ @æåŠä¸‹æ‹‰åœ¨æ˜¾ç¤ºåˆ™é€‰ä¸­ç¬¬ä¸€æ¡
    const suggest = document.getElementById('atSuggest');
    if (!suggest.classList.contains('hidden')) {
      suggest.querySelector('.at-suggest-item')?.click();
      return;
    }
    sendMessage();
  }
}

function handleInputChange(el) {
  // è‡ªåŠ¨é«˜åº¦
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 130) + 'px';
  // @ æåŠæ£€æµ‹
  detectAtMention(el);
}

/** æ£€æµ‹å¹¶æ¸²æŸ“ @æåŠä¸‹æ‹‰ */
function detectAtMention(el) {
  if (currentSession?.type !== 'group') return;
  const val    = el.value;
  const pos    = el.selectionStart;
  const before = val.slice(0, pos);
  const match  = before.match(/@(\S*)$/);
  const suggest = document.getElementById('atSuggest');

  if (!match) { suggest.classList.add('hidden'); return; }
  const query   = match[1].toLowerCase();
  const gid     = currentSession.id;
  const members = (groupMembers[gid] ?? []).filter(m =>
    m.uid != ME.uid && (!query || m.nickname.toLowerCase().includes(query)));

  if (!members.length) { suggest.classList.add('hidden'); return; }
  suggest.classList.remove('hidden');
  suggest.innerHTML = members.slice(0, 8).map(m => `
    <div class="at-suggest-item" onclick="selectAtMention('${escHtml(m.nickname)}')">
      ${avatarHtml(m.nickname, 'avatar-xs')}
      <span>${escHtml(m.nickname)}</span>
    </div>`).join('');
}

function selectAtMention(nick) {
  const el  = document.getElementById('chatInput');
  const val = el.value;
  const pos = el.selectionStart;
  // æ›¿æ¢ @xxx å‰ç¼€
  const before   = val.slice(0, pos).replace(/@\S*$/, `@${nick} `);
  el.value = before + val.slice(pos);
  el.focus();
  el.selectionStart = el.selectionEnd = before.length;
  document.getElementById('atSuggest').classList.add('hidden');
}

// ================================================================
//  å¼•ç”¨å›å¤
// ================================================================
function setReply(msg) {
  replyMsg = msg;
  const preview = String(msg.content ?? '').slice(0, 40);
  document.getElementById('replyPreview').textContent = `${msg.from_nickname ?? msg.from_uid}: ${preview}`;
  document.getElementById('replyBar').classList.remove('hidden');
  document.getElementById('chatInput').focus();
}

function clearReply() {
  replyMsg = null;
  document.getElementById('replyBar').classList.add('hidden');
}

// ================================================================
//  æ¶ˆæ¯é•¿æŒ‰èœå•
// ================================================================
function showMsgMenu(e, pkt) {
  const isSelf = pkt.from_uid == ME.uid;
  const items  = [
    { label: 'å¼•ç”¨å›å¤', icon: 'â†©', action: () => setReply(pkt) },
    { label: 'å¤åˆ¶æ–‡å­—', icon: 'ğŸ“‹', action: () => navigator.clipboard?.writeText(pkt.content ?? '') },
  ];
  if (isSelf) {
    items.push('divider');
    items.push({ label: 'æ’¤å›æ¶ˆæ¯', icon: 'â†©', danger: true, action: () => recallMsg(pkt) });
  }
  if (ME.role >= 3) {
    items.push({ label: 'è®¾ä¸ºç²¾å', icon: 'â­', action: () => api('msg/essence', { msg_id: pkt.msg_id, is_essence: 1 }).then(r => toast(r.msg, r.code===0?'success':'error')) });
    items.push({ label: 'ç½®é¡¶æ¶ˆæ¯', icon: 'ğŸ“Œ', action: () => api('msg/top',     { msg_id: pkt.msg_id, is_top: 1     }).then(r => toast(r.msg, r.code===0?'success':'error')) });
  }
  showContextMenu(e, items);
}

async function recallMsg(pkt) {
  const res = await api('msg/recall', { msg_id: pkt.msg_id });
  if (res.code === 0) {
    const el = document.querySelector(`[data-msg-id="${pkt.msg_id}"] .msg-bubble`);
    if (el) { el.textContent = 'æ¶ˆæ¯å·²è¢«æ’¤å›'; el.classList.add('text-muted'); }
  }
  toast(res.msg, res.code === 0 ? 'success' : 'error');
}

// ================================================================
//  æœç´¢æ¶ˆæ¯
// ================================================================
function openMsgSearch() {
  if (!currentSession) return;
  showModal({
    title: 'æœç´¢æ¶ˆæ¯',
    body: `<div class="form-group">
      <input class="form-input" id="searchKeyword" placeholder="è¾“å…¥å…³é”®è¯â€¦" autofocus />
    </div>
    <div id="searchResults" style="max-height:300px;overflow-y:auto;margin-top:.75rem"></div>`,
    confirmText: 'æœç´¢',
    onConfirm: async () => {
      const kw  = document.getElementById('searchKeyword').value.trim();
      if (!kw) return;
      const res = await api('msg/search', {
        chat_type: currentSession.type === 'group' ? 2 : 1,
        to_id:     currentSession.id,
        keyword:   kw,
      });
      const container = document.getElementById('searchResults');
      if (!container) return;
      if (res.code !== 0 || !res.data?.length) {
        container.innerHTML = '<p style="color:var(--text-muted);font-size:.85rem;text-align:center">æœªæ‰¾åˆ°ç›¸å…³æ¶ˆæ¯</p>';
        return;
      }
      container.innerHTML = res.data.slice(0, 20).map(m => `
        <div style="padding:.5rem;border-bottom:1px solid var(--border);font-size:.85rem">
          <div style="color:var(--text-muted);font-size:.75rem">${formatTime(m.ts)}</div>
          <div>${parseContent(m.content ?? '')}</div>
        </div>`).join('');
      return true; // é˜»æ­¢å…³é—­
    }
  });
}

// ================================================================
//  å¤´åƒç‚¹å‡» â†’ æŸ¥çœ‹èµ„æ–™
// ================================================================
async function clickAvatar(uid) {
  if (!uid) return;
  const res = await api('user/info', { uid }, 'GET');
  if (res.code !== 0) { toast(res.msg, 'error'); return; }
  const u = res.data;
  showModal({
    title: 'ç”¨æˆ·èµ„æ–™',
    body: `
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
        ${u.avatar ? `<img src="${escHtml(u.avatar)}" class="avatar avatar-lg">` : avatarHtml(u.nickname, 'avatar-lg')}
        <div>
          <div class="font-bold text-lg">${escHtml(u.nickname)}</div>
          <div class="text-sm text-muted">ID: ${u.uid}</div>
          <div class="text-xs text-muted" style="margin-top:.25rem">${u.is_online ? 'ğŸŸ¢ åœ¨çº¿' : 'âš« ç¦»çº¿'}</div>
        </div>
      </div>`,
    confirmText: 'å‘ç§ä¿¡',
    onConfirm: () => {
      openSession({ type: 'private', id: String(u.uid), name: u.nickname, avatar: u.avatar, online: u.is_online });
    }
  });
}

// ================================================================
//  ä¾§è¾¹åˆ‡æ¢é¢æ¿
// ================================================================
function switchPanel(name) {
  ['chat', 'contact'].forEach(p => {
    document.getElementById(`panel-${p}`).classList.toggle('hidden', p !== name);
    document.getElementById(`nav-${p}`)?.classList.toggle('active', p === name);
  });
  // æ‰‹æœºç«¯æ˜¾ç¤ºé¢æ¿
  if (window.innerWidth <= 768) {
    document.getElementById(`panel-${name}`).classList.add('open');
  }
}

function closeChat() {
  document.getElementById('panel-chat').classList.add('open');
  if (window.innerWidth <= 768) {
    document.getElementById('chatContainer').style.display = 'none';
    document.getElementById('chatEmpty').style.display = 'flex';
  }
}

// ================================================================
//  åœ¨çº¿äººæ•°
// ================================================================
async function loadOnlineCount() {
  const res = await api('user/online_count', {}, 'GET');
  if (res.code === 0) {
    document.getElementById('totalCount').textContent  = res.data.total;
    document.getElementById('onlineCount').textContent = res.data.online;
  }
}

// ================================================================
//  è‡ªå·±çš„å¤´åƒ
// ================================================================
function renderSelfAvatar() {
  const wrap = document.getElementById('self-avatar-btn');
  if (ME.avatar) {
    wrap.innerHTML = `<img src="${escHtml(ME.avatar)}" class="avatar" style="width:36px;height:36px">`;
  } else {
    wrap.innerHTML = avatarHtml(ME.nickname, 'avatar-sm');
  }
}

// ================================================================
//  "æˆ‘çš„"èœå•
// ================================================================
function showMeMenu() {
  showModal({
    title: 'æˆ‘çš„è´¦å·',
    body: `
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
        <label style="cursor:pointer;position:relative" title="ç‚¹å‡»æ›´æ¢å¤´åƒ">
          <div id="meAvatar">
            ${ME.avatar ? `<img src="${escHtml(ME.avatar)}" class="avatar avatar-lg">` : avatarHtml(ME.nickname, 'avatar-lg')}
          </div>
          <span style="position:absolute;bottom:0;right:0;background:var(--primary);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7rem">ğŸ“·</span>
          <input type="file" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
        </label>
        <div>
          <div class="font-semibold text-lg">${escHtml(ME.nickname)}</div>
          <div class="text-sm text-muted">ID: ${ME.uid}</div>
        </div>
      </div>`,
    confirmText: 'é€€å‡ºç™»å½•',
    destructive: true,
    onConfirm: async () => {
      showModal({
        title: 'ç¡®è®¤é€€å‡º',
        body: '<p>æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ</p>',
        confirmText: 'é€€å‡ºç™»å½•',
        destructive: true,
        onConfirm: async () => {
          await api('auth/logout', {});
          location.href = '/auth.html';
        }
      });
      return true;
    }
  });
}

async function uploadAvatar(input) {
  if (!input.files.length) return;
  const form = new FormData();
  form.append('avatar', input.files[0]);
  showLoading('ä¸Šä¼ ä¸­â€¦');
  const res = await apiUpload('user/avatar', form);
  hideLoading();
  if (res.code === 0) {
    ME.avatar = res.path;
    renderSelfAvatar();
    toast('å¤´åƒå·²æ›´æ–°', 'success');
  } else {
    toast(res.msg || 'ä¸Šä¼ å¤±è´¥', 'error');
  }
}

// ================================================================
//  åˆ›å»ºç¾¤ç»„
// ================================================================
function createGroupModal() {
  showModal({
    title: 'åˆ›å»ºç¾¤ç»„',
    body: `<div class="form-group">
      <label class="form-label">ç¾¤åç§°</label>
      <input class="form-input" id="newGroupName" placeholder="è¯·è¾“å…¥ç¾¤åç§°" maxlength="30" autofocus />
    </div>`,
    confirmText: 'åˆ›å»º',
    onConfirm: async () => {
      const name = document.getElementById('newGroupName')?.value?.trim();
      if (!name) { toast('ç¾¤åç§°ä¸èƒ½ä¸ºç©º', 'error'); return; }
      const res = await api('group/create', { name });
      if (res.code === 0) {
        toast(`ç¾¤ç»„åˆ›å»ºæˆåŠŸï¼Œç¾¤å·ï¼š${res.gid}`, 'success');
        await loadSessions();
      } else {
        toast(res.msg, 'error');
      }
    }
  });
}

// ================================================================
//  æ·»åŠ å¥½å‹
// ================================================================
function addFriendModal() {
  showModal({
    title: 'æ·»åŠ å¥½å‹',
    body: `<div class="form-group">
      <label class="form-label">ç”¨æˆ· ID</label>
      <input class="form-input" id="targetUid" type="number" placeholder="è¾“å…¥å¯¹æ–¹çš„ç”¨æˆ· ID" autofocus />
    </div>`,
    confirmText: 'æ·»åŠ ',
    onConfirm: async () => {
      const uid = parseInt(document.getElementById('targetUid')?.value);
      if (!uid) { toast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ· ID', 'error'); return; }
      const res = await api('friend/add', { target_uid: uid });
      toast(res.msg, res.code === 0 ? 'success' : 'error');
      if (res.code === 0) await loadSessions();
    }
  });
}

// ================================================================
//  å…¨å±€æœç´¢
// ================================================================
function openGlobalSearch() {
  toast('å…¨å±€æœç´¢åŠŸèƒ½å³å°†ä¸Šçº¿', 'info');
}

// ================================================================
//  å³ä¾§ä¿¡æ¯é¢æ¿
// ================================================================
function toggleInfoPanel() {
  const panel = document.getElementById('infoPanel');
  const isOpen = panel.style.display !== 'none';
  panel.style.display = isOpen ? 'none' : '';
  if (!isOpen && currentSession?.type === 'group') {
    renderInfoPanel();
  }
}

function renderInfoPanel() {
  const gid     = currentSession?.id;
  const members = groupMembers[gid] ?? [];
  const panel   = document.getElementById('infoPanelContent');
  panel.innerHTML = `
    <div style="font-weight:700;margin-bottom:1rem">ç¾¤æˆå‘˜ (${members.length})</div>
    ${members.map(m => `
      <div style="display:flex;align-items:center;gap:.625rem;padding:.4rem 0;cursor:pointer" onclick="clickAvatar(${m.uid})">
        ${m.avatar ? `<img src="${escHtml(m.avatar)}" class="avatar avatar-xs">` : avatarHtml(m.nickname, 'avatar-xs')}
        <div style="flex:1;min-width:0">
          <div class="truncate text-sm font-semibold">${escHtml(m.nickname)}</div>
          ${m.title ? `<div class="text-xs" style="color:var(--primary)">${escHtml(m.title)}</div>` : ''}
        </div>
        ${m.is_online ? '<span style="width:7px;height:7px;background:#22c55e;border-radius:50%;flex-shrink:0"></span>' : ''}
      </div>`).join('')}`;
}

// ================================================================
//  ä¸»èœå•
// ================================================================
function showMainMenu(btn) {
  const items = [
    { label: 'åˆ›å»ºç¾¤ç»„', icon: 'ğŸ‘¥', action: createGroupModal },
    { label: 'æ·»åŠ å¥½å‹', icon: 'â•', action: addFriendModal },
    ...(ME.role >= 3 ? [{ label: 'ç®¡ç†åå°', icon: 'âš™ï¸', action: () => { location.href = '/admin.html'; } }] : []),
  ];
  showContextMenu({ clientX: btn.getBoundingClientRect().right - 20, clientY: btn.getBoundingClientRect().bottom + 4 }, items);
}

function showChatMenu() {
  if (!currentSession) return;
  const isGroup   = currentSession.type === 'group';
  const gid       = currentSession.id;
  const gm        = (groupMembers[gid] ?? []).find(m => m.uid == ME.uid);
  const myRole    = gm?.role ?? 0; // 0=æˆå‘˜ 1=ç®¡ç†å‘˜ 2=ç¾¤ä¸»
  const items = [];

  if (isGroup) {
    if (ME.role >= 3 || myRole >= 1) {
      items.push({ label: 'å‘å¸ƒå…¬å‘Š', icon: 'ğŸ“¢', action: () => publishNotice(gid) });
    }
    if (myRole >= 2) {
      items.push({ label: 'è§£æ•£ç¾¤ç»„', icon: 'ğŸ—‘ï¸', danger: true, action: () => dissolveGroup(gid) });
      items.push({ label: 'è½¬è®©ç¾¤ä¸»', icon: 'ğŸ‘‘', action: () => transferGroup(gid) });
    }
  }
  items.push({ label: 'æœç´¢æ¶ˆæ¯', icon: 'ğŸ”', action: openMsgSearch });
  const menuBtn = document.getElementById('chatMenuBtn');
  showContextMenu({ clientX: menuBtn.getBoundingClientRect().right - 20, clientY: menuBtn.getBoundingClientRect().bottom + 4 }, items);
}

async function publishNotice(gid) {
  showModal({
    title: 'å‘å¸ƒç¾¤å…¬å‘Š',
    body: `<div class="form-group"><textarea class="form-input" id="noticeText" rows="4" placeholder="å…¬å‘Šå†…å®¹â€¦" maxlength="500"></textarea></div>`,
    confirmText: 'å‘å¸ƒ',
    onConfirm: async () => {
      const content = document.getElementById('noticeText')?.value?.trim();
      if (!content) return;
      const res = await api('notice/set', { gid, content });
      toast(res.msg, res.code === 0 ? 'success' : 'error');
      if (res.code === 0) loadGroupNotice(gid);
    }
  });
}

async function dissolveGroup(gid) {
  showModal({
    title: 'è§£æ•£ç¾¤ç»„',
    body: '<p class="text-sm">âš ï¸ è§£æ•£åç¾¤ç»„å°†æ— æ³•æ¢å¤ï¼Œç¡®å®šè¦è§£æ•£å—ï¼Ÿ</p>',
    confirmText: 'ç¡®è®¤è§£æ•£',
    destructive: true,
    onConfirm: async () => {
      const res = await api('group/dissolve', { gid });
      toast(res.msg, res.code === 0 ? 'success' : 'error');
      if (res.code === 0) { currentSession = null; document.getElementById('chatEmpty').style.display = 'flex'; document.getElementById('chatContainer').style.display = 'none'; await loadSessions(); }
    }
  });
}

function transferGroup(gid) {
  showModal({
    title: 'è½¬è®©ç¾¤ä¸»',
    body: `<div class="form-group">
      <label class="form-label">è¾“å…¥æ–°ç¾¤ä¸» UID</label>
      <input class="form-input" id="newOwnerUid" type="number" placeholder="æ–°ç¾¤ä¸»ç”¨æˆ· ID" autofocus />
    </div>`,
    confirmText: 'ç¡®è®¤è½¬è®©',
    onConfirm: async () => {
      const uid = parseInt(document.getElementById('newOwnerUid')?.value);
      if (!uid) { toast('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ· ID', 'error'); return; }
      const res = await api('group/transfer', { gid, target_uid: uid });
      toast(res.msg, res.code === 0 ? 'success' : 'error');
    }
  });
}

// ================================================================
//  å·¥å…·ï¼šé•¿æŒ‰äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
// ================================================================
function makeLongPressHandler(callback) {
  let timer = null;
  return function(e) {
    timer = setTimeout(() => { callback(e); timer = null; }, 600);
    document.addEventListener('touchend',  () => { if (timer) clearTimeout(timer); }, { once: true });
    document.addEventListener('touchmove', () => { if (timer) clearTimeout(timer); }, { once: true });
  };
}
</script>
</body>
</html>
