<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æèŠç®¡ç†åå°</title>
  <link rel="stylesheet" href="/assets/css/app.css" />
  <style>
    /* â”€â”€ åå°ç§æœ‰æ ·å¼ â”€â”€ */
    body { background: var(--surface-2); }
    .admin-wrap { display: flex; height: 100vh; overflow: hidden; }

    /* ä¾§è¾¹æ  */
    .admin-sidebar {
      width: 220px; flex-shrink: 0;
      background: var(--surface-1);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto;
    }
    .admin-brand {
      padding: 1.25rem 1.5rem;
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
    }
    .admin-nav-group { padding: .625rem 0; }
    .admin-nav-label {
      padding: .25rem 1.25rem;
      font-size: .7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--text-muted);
    }
    .admin-nav-item {
      display: flex; align-items: center; gap: .625rem;
      padding: .5rem 1.25rem;
      cursor: pointer;
      font-size: .875rem;
      color: var(--text-secondary);
      transition: background .15s, color .15s;
      border-radius: 0;
    }
    .admin-nav-item:hover { background: var(--surface-2); color: var(--text-primary); }
    .admin-nav-item.active { background: rgba(79,115,248,.1); color: var(--primary); font-weight: 600; }
    .admin-nav-item .nav-icon { font-size: 1.1em; flex-shrink: 0; }

    /* ä¸»å†…å®¹åŒº */
    .admin-main {
      flex: 1; min-width: 0;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .admin-main-content {
      flex: 1; overflow-y: auto;
      padding: 1.5rem 2rem;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .stat-card {
      background: var(--surface-1); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1.25rem 1.5rem;
    }
    .stat-card .stat-val { font-size: 1.75rem; font-weight: 800; color: var(--primary); }
    .stat-card .stat-label { font-size: .8rem; color: var(--text-muted); margin-top: .25rem; }

    /* æ•°æ®è¡¨æ ¼ */
    .data-table { width: 100%; border-collapse: collapse; font-size: .85rem; }
    .data-table th, .data-table td { text-align: left; padding: .625rem .875rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .data-table th { font-weight: 600; background: var(--surface-2); color: var(--text-secondary); font-size: .78rem; text-transform: uppercase; letter-spacing: .04em; }
    .data-table tr:hover td { background: var(--surface-2); }
    .data-table .actions { display: flex; gap: .375rem; }

    /* çŠ¶æ€å¾½ç«  */
    .status-badge { display: inline-block; padding: .15rem .5rem; border-radius: 999px; font-size: .72rem; font-weight: 600; }
    .status-badge.ok     { background: rgba(34,197,94,.12); color: #16a34a; }
    .status-badge.frozen { background: rgba(239,68,68,.12); color: #dc2626; }
    .status-badge.muted  { background: rgba(245,158,11,.12); color: #d97706; }

    /* è®¾ç½®é¡µ */
    .settings-section { background: var(--surface-1); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; }
    .settings-section h3 { font-size: .9rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: .625rem; border-bottom: 1px solid var(--border); }

    .page-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.25rem; color: var(--text-primary); }

    /* ç§»åŠ¨ç«¯é¡¶æ ï¼ˆæ±‰å ¡æŒ‰é’®ï¼‰ */
    .admin-topbar {
      display: none;
      align-items: center; gap: .75rem;
      padding: .875rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface-1);
      position: sticky; top: 0; z-index: 10;
      flex-shrink: 0;
    }
    .admin-topbar-title { font-weight: 700; font-size: .95rem; color: var(--primary); }
    .hamburger-btn {
      background: none; border: none; cursor: pointer;
      font-size: 1.4rem; line-height: 1; padding: .25rem;
      color: var(--text-primary);
    }
    .admin-main { display: flex; flex-direction: column; }
    .admin-main-content { flex: 1; overflow-y: auto; padding: 1.5rem 2rem; }
    @media (max-width: 640px) { .admin-main-content { padding: 1rem; } }
  </style>
</head>
<body>

<!-- å…¨å±åŠ è½½ -->
<div class="loading-overlay" id="initOverlay">
  <div class="spinner"></div>
  <p>æƒé™éªŒè¯ä¸­â€¦</p>
</div>

<div class="admin-wrap" id="adminRoot" style="visibility:hidden">

  <!-- ç§»åŠ¨ç«¯è’™å±‚é®ç½© -->
  <div class="admin-sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>

  <!-- ä¾§è¾¹æ  -->
  <aside class="admin-sidebar" id="adminSidebar">
    <div class="admin-brand">æèŠåå°</div>

    <div class="admin-nav-group">
      <div class="admin-nav-label">æ¦‚è§ˆ</div>
      <div class="admin-nav-item active" onclick="showPage('dashboard')">
        <span class="nav-icon">ğŸ“Š</span><span>æ§åˆ¶å°</span>
      </div>
    </div>

    <div class="admin-nav-group">
      <div class="admin-nav-label">ç”¨æˆ·ä¸ç¾¤ç»„</div>
      <div class="admin-nav-item" onclick="showPage('users')">
        <span class="nav-icon">ğŸ‘¤</span><span>ç”¨æˆ·ç®¡ç†</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('groups')">
        <span class="nav-icon">ğŸ‘¥</span><span>ç¾¤ç»„ç®¡ç†</span>
      </div>
    </div>

    <div class="admin-nav-group">
      <div class="admin-nav-label">ç³»ç»Ÿé…ç½®</div>
      <div class="admin-nav-item" onclick="showPage('settings-basic')">
        <span class="nav-icon">âš™ï¸</span><span>åŸºç¡€è®¾ç½®</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('settings-smtp')">
        <span class="nav-icon">ğŸ“§</span><span>é‚®ä»¶é…ç½®</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('settings-security')">
        <span class="nav-icon">ğŸ”’</span><span>å®‰å…¨è®¾ç½®</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('settings-theme')">
        <span class="nav-icon">ğŸ¨</span><span>ä¸»é¢˜å®šåˆ¶</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('settings-recall')">
        <span class="nav-icon">â†©ï¸</span><span>æ’¤å›è®¾ç½®</span>
      </div>
      <div class="admin-nav-item" onclick="showPage('settings-skin')">
        <span class="nav-icon">ğŸ¨</span><span>ç•Œé¢çš®è‚¤</span>
      </div>
    </div>

    <div style="flex:1"></div>
    <div class="admin-nav-group">
      <div class="admin-nav-item" onclick="goApp()">
        <span class="nav-icon">ğŸ’¬</span><span>è¿”å›èŠå¤©</span>
      </div>
      <div class="admin-nav-item js-theme-toggle">
        <span class="nav-icon">ğŸŒ™</span><span>åˆ‡æ¢ä¸»é¢˜</span>
      </div>
    </div>
  </aside>

  <!-- ä¸»å†…å®¹ -->
  <main class="admin-main" id="adminMainWrap">
    <!-- ç§»åŠ¨ç«¯é¡¶æ  -->
    <div class="admin-topbar" id="adminTopbar">
      <button class="hamburger-btn" onclick="toggleSidebar(true)">â˜°</button>
      <span class="admin-topbar-title">æèŠåå°</span>
    </div>
    <!-- å†…å®¹åŒº -->
    <div id="adminMain" class="admin-main-content">
      <!-- å†…å®¹ç”± JS åŠ¨æ€æ¸²æŸ“ -->
    </div>
  </main>

</div>

<div id="toast-container"></div>
<script src="/assets/js/common.js"></script>
<script>
'use strict';

let ME = null;
let settings = {};   // ç¼“å­˜ç³»ç»Ÿè®¾ç½® key:val
let currentPage = 'dashboard';

// ================================================================
//  ä¾§è¾¹æ åˆ‡æ¢ï¼ˆç§»åŠ¨ç«¯ï¼‰
// ================================================================
function toggleSidebar(open) {
  document.getElementById('adminSidebar').classList.toggle('open', open);
  document.getElementById('sidebarOverlay').classList.toggle('open', open);
}

// ================================================================
//  åˆå§‹åŒ–
// ================================================================
(async function init() {
  const res = await api('auth/me', {}, 'GET');
  if (!res.data || res.data.role < 3) {
    location.href = '/auth.html';
    return;
  }
  ME = res.data;
  document.getElementById('initOverlay').style.display = 'none';
  document.getElementById('adminRoot').style.visibility = '';
  await showPage('dashboard');
})();

// ================================================================
//  ä¾§è¾¹æ å¯¼èˆª
// ================================================================
async function showPage(name) {
  currentPage = name;
  document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.admin-nav-item[onclick="showPage('${name}')"]`)?.classList.add('active');
  // æ‰‹æœºç«¯é€‰å®Œé¡µé¢åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
  if (window.innerWidth <= 640) toggleSidebar(false);
  const main = document.getElementById('adminMain');
  main.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-muted)"><div class="spinner" style="margin:auto"></div></div>';
  switch (name) {
    case 'dashboard':       await renderDashboard(); break;
    case 'users':           await renderUsers(); break;
    case 'groups':          await renderGroups(); break;
    case 'settings-basic':  await renderSettings('basic'); break;
    case 'settings-smtp':   await renderSettings('smtp'); break;
    case 'settings-security': await renderSettings('security'); break;
    case 'settings-theme':  await renderSettings('theme'); break;
    case 'settings-recall': await renderSettings('recall'); break;
    case 'settings-skin':   await renderSkinPage(); break;
  }
}

// ================================================================
//  æ§åˆ¶å°
// ================================================================
async function renderDashboard() {
  const res = await api('admin/stats', {}, 'GET');
  const d   = res.data ?? { total_users: '-', online_users: '-', total_groups: '-', total_messages: '-' };
  document.getElementById('adminMain').innerHTML = `
    <div class="page-title">æ§åˆ¶å°æ¦‚è§ˆ</div>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-val" id="su">${d.total_users}</div>
        <div class="stat-label">æ³¨å†Œç”¨æˆ·æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="so">${d.online_users}</div>
        <div class="stat-label">å½“å‰åœ¨çº¿</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="sg">${d.total_groups}</div>
        <div class="stat-label">ç¾¤ç»„æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-val" id="sm">${d.total_messages}</div>
        <div class="stat-label">ç´¯è®¡æ¶ˆæ¯</div>
      </div>
    </div>
    <div style="margin-top:2rem;background:var(--surface-1);border:1px solid var(--border);border-radius:var(--radius);padding:1.5rem">
      <h3 style="font-size:.9rem;font-weight:700;margin-bottom:.75rem">å¿«é€Ÿæ“ä½œ</h3>
      <div style="display:flex;gap:.75rem;flex-wrap:wrap">
        <button class="btn btn-primary btn-sm" onclick="showPage('users')">ğŸ‘¤ ç®¡ç†ç”¨æˆ·</button>
        <button class="btn btn-secondary btn-sm" onclick="showPage('groups')">ğŸ‘¥ ç®¡ç†ç¾¤ç»„</button>
        <button class="btn btn-secondary btn-sm" onclick="showPage('settings-smtp')">ğŸ“§ é…ç½®é‚®ä»¶</button>
      </div>
    </div>`;
  // å®šæ—¶åˆ·æ–°åœ¨çº¿äººæ•°
  const onlineRes = await api('user/online_count', {}, 'GET');
  if (onlineRes.code === 0) {
    const el = document.getElementById('so');
    if (el) el.textContent = onlineRes.data.online;
  }
}

// ================================================================
//  ç”¨æˆ·ç®¡ç†
// ================================================================
let userPage = 1;
const USER_SIZE = 20;

async function renderUsers(page = 1, search = '') {
  userPage = page;
  const res = await api('admin/users', { page, size: USER_SIZE, q: search }, 'GET');
  const users = Array.isArray(res.data) ? res.data : [];
  const total = res.total ?? 0;

  document.getElementById('adminMain').innerHTML = `
    <div class="page-title">ç”¨æˆ·ç®¡ç†</div>
    <div style="display:flex;gap:.625rem;margin-bottom:1rem;align-items:center">
      <input class="form-input" id="userSearch" placeholder="æœç´¢æ˜µç§°/UIDâ€¦" style="max-width:240px" value="${escHtml(search)}" onkeydown="if(event.key==='Enter')renderUsers(1,this.value.trim())" />
      <button class="btn btn-primary btn-sm" onclick="renderUsers(1,document.getElementById('userSearch').value.trim())">æœç´¢</button>
    </div>
    <div style="overflow-x:auto;background:var(--surface-1);border:1px solid var(--border);border-radius:var(--radius)">
      <table class="data-table">
        <thead><tr>
          <th>UID</th><th>æ˜µç§°</th><th>ç”¨æˆ·å</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody id="userTbody">
          ${users.length ? users.map(u => userRow(u)).join('') : '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">æš‚æ— ç”¨æˆ·</td></tr>'}
        </tbody>
      </table>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.875rem;font-size:.82rem;color:var(--text-muted)">
      <span>å…± ${total} æ¡</span>
      <div style="display:flex;gap:.375rem">
        ${page > 1 ? `<button class="btn btn-secondary btn-xs" onclick="renderUsers(${page-1},'${escHtml(search)}')">ä¸Šä¸€é¡µ</button>` : ''}
        ${total > page * USER_SIZE ? `<button class="btn btn-secondary btn-xs" onclick="renderUsers(${page+1},'${escHtml(search)}')">ä¸‹ä¸€é¡µ</button>` : ''}
      </div>
    </div>`;
}

function userRow(u) {
  const roleLabel = { 1: 'æ™®é€š', 2: 'VIP', 3: 'ç®¡ç†å‘˜', 9: 'è¶…ç®¡' }[u.role] ?? 'æ™®é€š';
  const statusMap = { 0: ['frozen','å·²å°ç¦'], 1: ['ok','æ­£å¸¸'], 2: ['frozen','å·²å†»ç»“'] };
  const [cls, label] = statusMap[u.status] ?? ['ok','æ­£å¸¸'];
  return `<tr>
    <td>${u.uid}</td>
    <td>${escHtml(u.nickname)}</td>
    <td>${escHtml(u.username)}</td>
    <td>${roleLabel}</td>
    <td><span class="status-badge ${cls}">${label}</span></td>
    <td>${formatTime(u.created_at)}</td>
    <td><div class="actions">
      ${u.status === 1
        ? `<button class="btn btn-sm" style="background:rgba(245,158,11,.1);color:#d97706" onclick="setUserStatus(${u.uid},2,'ç¦è¨€')">ç¦è¨€</button>
           <button class="btn btn-sm" style="background:rgba(239,68,68,.1);color:#dc2626" onclick="setUserStatus(${u.uid},0,'å†»ç»“')">å†»ç»“</button>`
        : `<button class="btn btn-sm" style="background:rgba(34,197,94,.1);color:#16a34a" onclick="setUserStatus(${u.uid},1,'è§£å°')">è§£å°</button>`}
    </div></td>
  </tr>`;
}

async function setUserStatus(uid, status, label) {
  if (!confirm(`ç¡®å®šè¦${label}ç”¨æˆ· UID=${uid} å—ï¼Ÿ`)) return;
  const res = await api('admin/user/status', { uid, status });
  toast(res.msg, res.code === 0 ? 'success' : 'error');
  if (res.code === 0) renderUsers(userPage);
}

// ================================================================
//  ç¾¤ç»„ç®¡ç†
// ================================================================
async function renderGroups(search = '') {
  const res    = await api('admin/groups', { q: search }, 'GET');
  const groups = res.data ?? [];
  document.getElementById('adminMain').innerHTML = `
    <div class="page-title">ç¾¤ç»„ç®¡ç†</div>
    <div style="display:flex;gap:.625rem;margin-bottom:1rem;align-items:center">
      <input class="form-input" id="groupSearch" placeholder="æœç´¢ç¾¤åç§°/ç¾¤å·â€¦" style="max-width:240px" value="${escHtml(search)}" onkeydown="if(event.key==='Enter')renderGroups(this.value.trim())" />
      <button class="btn btn-primary btn-sm" onclick="renderGroups(document.getElementById('groupSearch').value.trim())">æœç´¢</button>
    </div>
    <div style="overflow-x:auto;background:var(--surface-1);border:1px solid var(--border);border-radius:var(--radius)">
      <table class="data-table">
        <thead><tr>
          <th>ç¾¤å·</th><th>ç¾¤å</th><th>ç¾¤ä¸» UID</th><th>æˆå‘˜æ•°</th><th>çŠ¶æ€</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody>
          ${groups.length ? groups.map(g => `
            <tr>
              <td>${escHtml(g.gid)}</td>
              <td>${escHtml(g.name)}</td>
              <td>${g.owner_uid}</td>
              <td>${g.member_count}</td>
              <td><span class="status-badge ${g.status===1?'ok':'frozen'}">${g.status===1?'æ­£å¸¸':'å·²è§£æ•£'}</span></td>
              <td>${formatTime(g.created_at)}</td>
              <td><div class="actions">
                <button class="btn btn-sm" style="background:rgba(239,68,68,.1);color:#dc2626" onclick="adminDissolveGroup('${escHtml(g.gid)}','${escHtml(g.name)}')">è§£æ•£</button>
              </div></td>
            </tr>`).join('') : '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">æš‚æ— ç¾¤ç»„</td></tr>'}
        </tbody>
      </table>
    </div>`;
}

async function adminDissolveGroup(gid, name) {
  if (!confirm(`ç¡®è®¤è§£æ•£ç¾¤ç»„ã€Œ${name}ã€(${gid})ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
  const res = await api('group/dissolve', { gid });
  toast(res.msg, res.code === 0 ? 'success' : 'error');
  if (res.code === 0) renderGroups();
}

// ================================================================
//  è®¾ç½®é¡µ
// ================================================================
const SETTING_PAGES = {
  basic: {
    title: 'åŸºç¡€è®¾ç½®',
    fields: [
      { key: 'app_name',       label: 'ç«™ç‚¹åç§°',       type: 'text', placeholder: 'æèŠï¼ˆå•†ç”¨ç‰ˆï¼‰' },
      { key: 'app_slogan',     label: 'ç«™ç‚¹å£å·',       type: 'text' },
      { key: 'index_bg',       label: 'é¦–é¡µèƒŒæ™¯å›¾ URL', type: 'text' },
      { key: 'auth_bg',        label: 'ç™»å½•é¡µèƒŒæ™¯å›¾ URL', type: 'text' },
      { key: 'register_open',  label: 'å¼€æ”¾æ³¨å†Œ',       type: 'toggle' },
    ]
  },
  smtp: {
    title: 'é‚®ä»¶ (SMTP) é…ç½®',
    fields: [
      { key: 'smtp_host',     label: 'SMTP ä¸»æœº',   type: 'text', placeholder: 'smtp.example.com' },
      { key: 'smtp_port',     label: 'SMTP ç«¯å£',   type: 'number', placeholder: '465' },
      { key: 'smtp_user',     label: 'é‚®ç®±è´¦å·',   type: 'text' },
      { key: 'smtp_pass',     label: 'é‚®ç®±å¯†ç ',   type: 'password' },
      { key: 'smtp_from',     label: 'å‘ä»¶äººåç§°', type: 'text', placeholder: 'æèŠç³»ç»Ÿ' },
      { key: 'smtp_ssl',      label: 'å¯ç”¨ SSL',   type: 'toggle' },
    ],
    extra: `<div style="margin-top:1rem">
      <button class="btn btn-secondary btn-sm" onclick="testSmtp()">ğŸ“§ å‘é€æµ‹è¯•é‚®ä»¶</button>
    </div>`
  },
  security: {
    title: 'å®‰å…¨è®¾ç½®',
    fields: [
      { key: 'captcha_enabled',         label: 'ç™»å½•å¯ç”¨æ»‘å—éªŒè¯',   type: 'toggle' },
      { key: 'email_verify_required',   label: 'æ³¨å†Œéœ€é‚®ç®±éªŒè¯',     type: 'toggle' },
      { key: 'phone_verify_required',   label: 'æ³¨å†Œéœ€æ‰‹æœºéªŒè¯',     type: 'toggle' },
      { key: 'login_fail_limit',        label: 'è¿ç»­å¤±è´¥é”å®šæ¬¡æ•°',   type: 'number', placeholder: '5' },
      { key: 'register_require_email',  label: 'æ³¨å†Œå¿…å¡«é‚®ç®±',       type: 'toggle' },
      { key: 'register_require_phone',  label: 'æ³¨å†Œå¿…å¡«æ‰‹æœº',       type: 'toggle' },
      { key: 'max_upload_mb',           label: 'æœ€å¤§ä¸Šä¼ å¤§å° (MB)',  type: 'number', placeholder: '10' },
    ]
  },
  theme: {
    title: 'ä¸»é¢˜å®šåˆ¶',
    fields: [
      { key: 'primary_color',   label: 'ä¸»è‰²è°ƒ (CSS é¢œè‰²å€¼)',     type: 'text', placeholder: '#4f73f8' },
      { key: 'custom_css',      label: 'è‡ªå®šä¹‰ CSS (é«˜çº§)',       type: 'textarea', rows: 8 },
      { key: 'custom_head_html', label: 'è‡ªå®šä¹‰ HEAD HTML (é«˜çº§)', type: 'textarea', rows: 4 },
    ]
  },
  recall: {
    title: 'æ¶ˆæ¯æ’¤å›è®¾ç½®',
    fields: [
      { key: 'recall_time_role1', label: 'æ™®é€šç”¨æˆ·æ’¤å›æ—¶é™ (ç§’)', type: 'number', placeholder: '120' },
      { key: 'recall_time_role2', label: 'VIP ç”¨æˆ·æ’¤å›æ—¶é™ (ç§’)',   type: 'number', placeholder: '300' },
      { key: 'recall_time_role3', label: 'ç®¡ç†å‘˜æ’¤å›æ—¶é™ (ç§’)',   type: 'number', placeholder: '3600' },
      { key: 'recall_time_role9', label: 'è¶…ç®¡æ’¤å›æ—¶é™ (ç§’)',       type: 'number', placeholder: '0 (ä¸é™)' },
    ]
  }
};

async function renderSettings(tab) {
  // è‹¥ settings è¿˜æœªåŠ è½½ï¼Œå…ˆæ‹‰ä¸€æ¬¡
  if (!Object.keys(settings).length) {
    const res = await api('admin/settings/get', { keys: '*' }, 'GET');
    settings  = res.data ?? {};
  }
  const cfg = SETTING_PAGES[tab];
  if (!cfg) return;

  const fieldsHtml = cfg.fields.map(f => {
    const val = escHtml(settings[f.key] ?? '');
    if (f.type === 'toggle') {
      const checked = settings[f.key] === '1' ? 'checked' : '';
      return `<div class="form-group" style="display:flex;align-items:center;justify-content:space-between">
        <label class="form-label" style="margin-bottom:0">${f.label}</label>
        <label class="toggle-switch">
          <input type="checkbox" id="s_${f.key}" name="${f.key}" ${checked} onchange="updateSettingToggle(this)" />
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
        </label>
      </div>`;
    }
    if (f.type === 'textarea') {
      return `<div class="form-group">
        <label class="form-label" for="s_${f.key}">${f.label}</label>
        <textarea class="form-input" id="s_${f.key}" name="${f.key}" rows="${f.rows ?? 4}" placeholder="${f.placeholder ?? ''}">${val}</textarea>
      </div>`;
    }
    return `<div class="form-group">
      <label class="form-label" for="s_${f.key}">${f.label}</label>
      <input class="form-input" type="${f.type}" id="s_${f.key}" name="${f.key}" value="${val}" placeholder="${escHtml(f.placeholder ?? '')}" />
    </div>`;
  }).join('');

  document.getElementById('adminMain').innerHTML = `
    <div class="page-title">${cfg.title}</div>
    <form class="settings-section" id="settingsForm">
      <h3>${cfg.title}</h3>
      ${fieldsHtml}
      ${cfg.extra ?? ''}
      <div style="margin-top:1.25rem">
        <button type="button" class="btn btn-primary" onclick="saveSettings('${tab}')">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
      </div>
    </form>`;
}

/** å¤é€‰æ¡†ç«‹å³æ›´æ–°ç¼“å­˜ */
function updateSettingToggle(el) {
  settings[el.name] = el.checked ? '1' : '0';
}

/** ä¿å­˜è®¾ç½® */
async function saveSettings(tab) {
  const cfg    = SETTING_PAGES[tab];
  const payload = {};
  cfg.fields.forEach(f => {
    const el = document.getElementById(`s_${f.key}`);
    if (!el) return;
    payload[f.key] = f.type === 'toggle' ? (el.checked ? '1' : '0') : el.value;
    settings[f.key] = payload[f.key]; // æ›´æ–°ç¼“å­˜
  });
  const res = await api('admin/settings/save', { settings: payload });
  toast(res.msg ?? (res.code === 0 ? 'è®¾ç½®å·²ä¿å­˜' : 'ä¿å­˜å¤±è´¥'), res.code === 0 ? 'success' : 'error');
}

/** å‘é€æµ‹è¯•é‚®ä»¶ */
async function testSmtp() {
  const email = prompt('è¯·è¾“å…¥æ¥æ”¶æµ‹è¯•é‚®ä»¶çš„é‚®ç®±åœ°å€ï¼š');
  if (!email) return;
  showLoading('å‘é€ä¸­â€¦');
  const res = await api('admin/mail/test', { email });
  hideLoading();
  toast(res.msg, res.code === 0 ? 'success' : 'error');
}

// ================================================================
//  ç•Œé¢çš®è‚¤é€‰æ‹©
// ================================================================
let selectedSkin = 'default';

async function renderSkinPage() {
  if (!Object.keys(settings).length) {
    const res = await api('admin/settings/get', { keys: '*' }, 'GET');
    settings = res.data ?? {};
  }
  selectedSkin = settings.ui_skin ?? 'default';
  _renderSkinCards();
}

function _renderSkinCards() {
  const cards = Object.entries(UI_THEMES).map(([key, t]) => {
    const isActive = key === selectedSkin;
    return `<div data-skin="${key}" onclick="selectSkin('${key}')" style="
        border-radius:12px;overflow:hidden;cursor:pointer;
        border:2.5px solid ${isActive ? 'var(--primary)' : 'var(--border)'};
        transition:.2s;background:var(--bg-card);box-shadow:var(--shadow-sm)">
      <div style="height:72px;background:${t.preview};position:relative;display:flex;align-items:center;justify-content:center;font-size:1.8rem">
        ${t.badge}
        ${isActive ? '<span style="position:absolute;top:5px;right:6px;background:var(--primary);color:#fff;font-size:.68rem;padding:.2rem .45rem;border-radius:999px;font-weight:600">âœ“ å½“å‰</span>' : ''}
      </div>
      <div style="padding:.55rem .8rem">
        <div style="font-size:.875rem;font-weight:600;color:var(--text-primary)">${t.label}</div>
        <div style="display:flex;gap:4px;margin-top:.3rem">
          ${t.vars['--primary'] ? `<span style="width:14px;height:14px;border-radius:50%;background:${t.vars['--primary']};display:inline-block"></span>` : '<span style="width:14px;height:14px;border-radius:50%;background:#4f73f8;display:inline-block"></span>'}
          ${t.vars['--bubble-self'] ? `<span style="width:14px;height:14px;border-radius:50%;background:${t.vars['--bubble-self']};display:inline-block"></span>` : ''}
          ${t.vars['--bg-sidebar'] ? `<span style="width:14px;height:14px;border-radius:50%;background:${t.vars['--bg-sidebar']};display:inline-block;border:1px solid var(--border)"></span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('adminMain').innerHTML = `
    <div class="page-title">ç•Œé¢çš®è‚¤</div>
    <p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1.25rem">
      ä¸ºå…¨ç«™é€‰æ‹©ä¸€ç§ä¸»é¢˜é£æ ¼ï¼Œç”¨æˆ·ä¸‹æ¬¡åˆ·æ–°é¡µé¢åè‡ªåŠ¨ç”Ÿæ•ˆã€‚
    </p>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(145px,1fr));gap:.875rem;margin-bottom:1.5rem" id="skinGrid">
      ${cards}
    </div>
    <div style="display:flex;align-items:center;gap:.75rem">
      <button class="btn btn-primary" onclick="saveSkin()">ğŸ’¾ åº”ç”¨çš®è‚¤</button>
      <span id="skinPreviewNote" style="font-size:.82rem;color:var(--text-muted)">ç‚¹å‡»å¡ç‰‡å³å¯é¢„è§ˆæ•ˆæœ</span>
    </div>`;
}

function selectSkin(name) {
  selectedSkin = name;
  applyUITheme(name); // ç«‹å³é¢„è§ˆ
  // åˆ·æ–°å¡ç‰‡é€‰ä¸­çŠ¶æ€
  document.querySelectorAll('#skinGrid > div[data-skin]').forEach(card => {
    const isActive = card.dataset.skin === name;
    card.style.borderColor = isActive ? 'var(--primary)' : 'var(--border)';
    const prev = card.querySelector('div:first-child');
    const badge = prev.querySelector('span');
    if (isActive && !badge) {
      const b = document.createElement('span');
      b.style.cssText = 'position:absolute;top:5px;right:6px;background:var(--primary);color:#fff;font-size:.68rem;padding:.2rem .45rem;border-radius:999px;font-weight:600';
      b.textContent = 'âœ“ å½“å‰';
      prev.appendChild(b);
    } else if (!isActive && badge) {
      badge.remove();
    }
  });
  document.getElementById('skinPreviewNote').textContent = `é¢„è§ˆä¸­ï¼š${UI_THEMES[name]?.label ?? name} â€” ç‚¹å‡»"åº”ç”¨çš®è‚¤"ä¿å­˜`;
}

async function saveSkin() {
  const res = await api('admin/settings/save', { settings: { ui_skin: selectedSkin } });
  if (res.code === 0) {
    settings.ui_skin = selectedSkin;
    toast(`çš®è‚¤ã€Œ${UI_THEMES[selectedSkin]?.label}ã€å·²ä¿å­˜ï¼Œå…¨ç«™ç”Ÿæ•ˆ`, 'success');
  } else {
    toast(res.msg ?? 'ä¿å­˜å¤±è´¥', 'error');
  }
}

function goApp() { location.href = '/app.html'; }
</script>
</body>
</html>
